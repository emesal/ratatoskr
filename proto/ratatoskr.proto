syntax = "proto3";
package ratatoskr.v1;

// =============================================================================
// Service Definition
// =============================================================================

service Ratatoskr {
    // Chat
    rpc Chat(ChatRequest) returns (ChatResponse);
    rpc ChatStream(ChatRequest) returns (stream ChatEvent);

    // Generation
    rpc Generate(GenerateRequest) returns (GenerateResponse);
    rpc GenerateStream(GenerateRequest) returns (stream GenerateEvent);

    // Embeddings
    rpc Embed(EmbedRequest) returns (EmbedResponse);
    rpc EmbedBatch(EmbedBatchRequest) returns (EmbedBatchResponse);

    // NLI
    rpc InferNli(NliRequest) returns (NliResponse);
    rpc InferNliBatch(NliBatchRequest) returns (NliBatchResponse);

    // Classification
    rpc ClassifyZeroShot(ClassifyRequest) returns (ClassifyResponse);
    rpc ClassifyStance(StanceRequest) returns (StanceResponse);

    // Tokenization
    rpc CountTokens(TokenCountRequest) returns (TokenCountResponse);
    rpc Tokenize(TokenizeRequest) returns (TokenizeResponse);

    // Model management
    rpc ListModels(ListModelsRequest) returns (ListModelsResponse);
    rpc ModelStatus(ModelStatusRequest) returns (ModelStatusResponse);
    rpc GetModelMetadata(ModelMetadataRequest) returns (ModelMetadataResponse);
    rpc FetchModelMetadata(ModelMetadataRequest) returns (ModelMetadataResponse);

    // Preset resolution
    rpc ResolvePreset(ResolvePresetRequest) returns (ResolvePresetResponse);
    rpc ListPresets(ListPresetsRequest) returns (ListPresetsResponse);

    // Service info
    rpc Health(HealthRequest) returns (HealthResponse);
    rpc GetCapabilities(CapabilitiesRequest) returns (CapabilitiesResponse);
}

// =============================================================================
// Common Types
// =============================================================================

message Usage {
    uint32 prompt_tokens = 1;
    uint32 completion_tokens = 2;
    uint32 total_tokens = 3;
    optional uint32 reasoning_tokens = 4;
}

enum FinishReason {
    FINISH_REASON_UNSPECIFIED = 0;
    FINISH_REASON_STOP = 1;
    FINISH_REASON_LENGTH = 2;
    FINISH_REASON_TOOL_CALLS = 3;
    FINISH_REASON_CONTENT_FILTER = 4;
}

// =============================================================================
// Message Types
// =============================================================================

message Message {
    Role role = 1;
    string content = 2;
    repeated ToolCall tool_calls = 3;
    optional string name = 4;
    optional string tool_call_id = 5;  // For tool role messages
}

enum Role {
    ROLE_UNSPECIFIED = 0;
    ROLE_SYSTEM = 1;
    ROLE_USER = 2;
    ROLE_ASSISTANT = 3;
    ROLE_TOOL = 4;
}

message ToolCall {
    string id = 1;
    string name = 2;
    string arguments = 3;  // JSON string
}

message ToolDefinition {
    string name = 1;
    string description = 2;
    string parameters_json = 3;  // JSON schema as string
}

// =============================================================================
// Chat Types
// =============================================================================

message ChatOptions {
    string model = 1;
    optional float temperature = 2;
    optional uint32 max_tokens = 3;
    optional float top_p = 4;
    repeated string stop = 5;
    optional float frequency_penalty = 6;
    optional float presence_penalty = 7;
    optional uint64 seed = 8;
    optional ToolChoice tool_choice = 9;
    optional ResponseFormat response_format = 10;
    optional bool cache_prompt = 11;
    optional ReasoningConfig reasoning = 12;
    optional uint32 top_k = 13;
    // Escape hatch: provider-specific options as JSON string.
    optional string raw_provider_options = 14;
    optional bool parallel_tool_calls = 15;
}

message ToolChoice {
    oneof choice {
        bool auto = 1;       // true = auto
        bool none = 2;       // true = none
        bool required = 3;   // true = required
        string function = 4; // specific function name
    }
}

message ResponseFormat {
    oneof format {
        bool text = 1;
        bool json_object = 2;
        string json_schema = 3;  // JSON schema as string
    }
}

message ReasoningConfig {
    optional ReasoningEffort effort = 1;
    optional uint32 max_tokens = 2;
    optional bool exclude_from_output = 3;
}

enum ReasoningEffort {
    REASONING_EFFORT_UNSPECIFIED = 0;
    REASONING_EFFORT_NONE = 1;
    REASONING_EFFORT_MINIMAL = 2;
    REASONING_EFFORT_LOW = 3;
    REASONING_EFFORT_MEDIUM = 4;
    REASONING_EFFORT_HIGH = 5;
    REASONING_EFFORT_XHIGH = 6;
}

message ChatRequest {
    repeated Message messages = 1;
    repeated ToolDefinition tools = 2;
    ChatOptions options = 3;
}

message ChatResponse {
    string content = 1;
    optional string reasoning = 2;
    repeated ToolCall tool_calls = 3;
    optional Usage usage = 4;
    optional string model = 5;
    FinishReason finish_reason = 6;
}

message ChatEvent {
    oneof event {
        string content = 1;
        string reasoning = 2;
        ToolCallStart tool_call_start = 3;
        ToolCallDelta tool_call_delta = 4;
        Usage usage = 5;
        bool done = 6;
        ToolCallEnd tool_call_end = 7;
    }
}

message ToolCallStart {
    uint32 index = 1;
    string id = 2;
    string name = 3;
}

message ToolCallDelta {
    uint32 index = 1;
    string arguments = 2;
}

message ToolCallEnd {
    uint32 index = 1;
}

// =============================================================================
// Generation Types
// =============================================================================

message GenerateRequest {
    string prompt = 1;
    GenerateOptions options = 2;
}

message GenerateOptions {
    string model = 1;
    optional uint32 max_tokens = 2;
    optional float temperature = 3;
    optional float top_p = 4;
    repeated string stop_sequences = 5;
    optional uint32 top_k = 6;
    optional float frequency_penalty = 7;
    optional float presence_penalty = 8;
    optional uint64 seed = 9;
    optional ReasoningConfig reasoning = 10;
}

message GenerateResponse {
    string text = 1;
    optional Usage usage = 2;
    optional string model = 3;
    FinishReason finish_reason = 4;
}

message GenerateEvent {
    oneof event {
        string text = 1;
        bool done = 2;
    }
}

// =============================================================================
// Embedding Types
// =============================================================================

message EmbedRequest {
    string text = 1;
    string model = 2;
}

message EmbedResponse {
    repeated float values = 1;
    string model = 2;
    uint32 dimensions = 3;
}

message EmbedBatchRequest {
    repeated string texts = 1;
    string model = 2;
}

message EmbedBatchResponse {
    repeated Embedding embeddings = 1;
}

message Embedding {
    repeated float values = 1;
    string model = 2;
    uint32 dimensions = 3;
}

// =============================================================================
// NLI Types
// =============================================================================

message NliRequest {
    string premise = 1;
    string hypothesis = 2;
    string model = 3;
}

message NliResponse {
    float entailment = 1;
    float contradiction = 2;
    float neutral = 3;
    NliLabel label = 4;
}

enum NliLabel {
    NLI_LABEL_UNSPECIFIED = 0;
    NLI_LABEL_ENTAILMENT = 1;
    NLI_LABEL_CONTRADICTION = 2;
    NLI_LABEL_NEUTRAL = 3;
}

message NliBatchRequest {
    repeated NliPair pairs = 1;
    string model = 2;
}

message NliPair {
    string premise = 1;
    string hypothesis = 2;
}

message NliBatchResponse {
    repeated NliResponse results = 1;
}

// =============================================================================
// Classification Types
// =============================================================================

message ClassifyRequest {
    string text = 1;
    repeated string labels = 2;
    string model = 3;
}

message ClassifyResponse {
    map<string, float> scores = 1;
    string top_label = 2;
    float confidence = 3;
}

message StanceRequest {
    string text = 1;
    string target = 2;
    string model = 3;
}

message StanceResponse {
    float favor = 1;
    float against = 2;
    float neutral = 3;
    StanceLabel label = 4;
    string target = 5;
}

enum StanceLabel {
    STANCE_LABEL_UNSPECIFIED = 0;
    STANCE_LABEL_FAVOR = 1;
    STANCE_LABEL_AGAINST = 2;
    STANCE_LABEL_NEUTRAL = 3;
}

// =============================================================================
// Tokenization Types
// =============================================================================

message TokenCountRequest {
    string text = 1;
    string model = 2;
}

message TokenCountResponse {
    uint32 count = 1;
}

message TokenizeRequest {
    string text = 1;
    string model = 2;
}

message TokenizeResponse {
    repeated Token tokens = 1;
}

message Token {
    uint32 id = 1;
    string text = 2;
    uint32 start = 3;
    uint32 end = 4;
}

// =============================================================================
// Model Management Types
// =============================================================================

message ListModelsRequest {}

message ListModelsResponse {
    repeated ModelInfo models = 1;
}

message ModelInfo {
    string id = 1;
    string provider = 2;
    repeated ModelCapability capabilities = 3;
    optional uint32 context_window = 4;
    optional uint32 dimensions = 5;
}

enum ModelCapability {
    MODEL_CAPABILITY_UNSPECIFIED = 0;
    MODEL_CAPABILITY_CHAT = 1;
    MODEL_CAPABILITY_GENERATE = 2;
    MODEL_CAPABILITY_EMBED = 3;
    MODEL_CAPABILITY_NLI = 4;
    MODEL_CAPABILITY_CLASSIFY = 5;
    MODEL_CAPABILITY_STANCE = 6;
    MODEL_CAPABILITY_CHAT_STREAMING = 7;
    MODEL_CAPABILITY_TOOL_USE = 8;
    MODEL_CAPABILITY_TOKEN_COUNTING = 9;
    MODEL_CAPABILITY_LOCAL_INFERENCE = 10;
}

message ModelStatusRequest {
    string model = 1;
}

message ModelStatusResponse {
    ModelStatus status = 1;
    optional string reason = 2;  // For unavailable status
}

enum ModelStatus {
    MODEL_STATUS_UNSPECIFIED = 0;
    MODEL_STATUS_AVAILABLE = 1;
    MODEL_STATUS_LOADING = 2;
    MODEL_STATUS_READY = 3;
    MODEL_STATUS_UNAVAILABLE = 4;
}

// =============================================================================
// Model Metadata Types (Phase 6)
// =============================================================================
//
// These types support querying model capabilities, parameter availability,
// and pricing information. The registry merges embedded seed data with
// live provider data to provide comprehensive model intelligence.

// Request model metadata by model ID.
message ModelMetadataRequest {
    // The model identifier (e.g., "claude-sonnet-4", "gpt-4o").
    string model = 1;
}

// Response containing model metadata if found.
message ModelMetadataResponse {
    // True if the model is known to the registry.
    bool found = 1;
    // The model metadata, present only if found is true.
    optional ProtoModelMetadata metadata = 2;
}

// Extended model information including parameters, pricing, and limits.
message ProtoModelMetadata {
    // Basic model info (id, capabilities, context window).
    ModelInfo info = 1;
    // Parameter availability map (which params are mutable, read-only, etc.).
    repeated ParameterEntry parameters = 2;
    // Pricing information (cost per million tokens).
    optional ProtoPricingInfo pricing = 3;
    // Maximum output tokens the model can generate.
    optional uint32 max_output_tokens = 4;
}

// A single parameter name and its availability.
message ParameterEntry {
    // Parameter name (e.g., "temperature", "max_tokens", or custom "x-provider-foo").
    string name = 1;
    // How this parameter can be used with the model.
    ProtoParameterAvailability availability = 2;
}

// Describes how a parameter can be used with a model.
//
// - mutable_range: Parameter can be set, optionally with min/max/default bounds.
// - read_only_json: Parameter has a fixed value (JSON-encoded) that cannot be changed.
// - opaque: Parameter exists but its constraints are unknown.
// - unsupported: Parameter is explicitly not supported by this model.
message ProtoParameterAvailability {
    oneof kind {
        // Parameter can be set, with optional numeric constraints.
        ProtoParameterRange mutable_range = 1;
        // Parameter has a fixed value (JSON-encoded string).
        string read_only_json = 2;
        // Parameter exists but constraints are unknown.
        bool opaque = 3;
        // Parameter is explicitly unsupported.
        bool unsupported = 4;
    }
}

// Numeric constraints for a mutable parameter.
message ProtoParameterRange {
    // Minimum allowed value (inclusive).
    optional double min = 1;
    // Maximum allowed value (inclusive).
    optional double max = 2;
    // Default value if not specified.
    optional double default_value = 3;
}

// Pricing information for API usage.
message ProtoPricingInfo {
    // Cost per million input (prompt) tokens in USD.
    optional double prompt_cost_per_mtok = 1;
    // Cost per million output (completion) tokens in USD.
    optional double completion_cost_per_mtok = 2;
}

// =============================================================================
// Health Types
// =============================================================================

message HealthRequest {}

message HealthResponse {
    bool healthy = 1;
    string version = 2;
    optional string git_sha = 3;
}

// =============================================================================
// Capabilities Types
// =============================================================================

message CapabilitiesRequest {}

message CapabilitiesResponse {
    repeated ModelCapability capabilities = 1;
}

// =============================================================================
// Preset Resolution Types
// =============================================================================

message ResolvePresetRequest {
    string tier = 1;
    string capability = 2;
}

// Default generation parameters attached to a preset.
// All fields are optional â€” unset means no default for that parameter.
message ProtoPresetParameters {
    optional float temperature = 1;
    optional float top_p = 2;
    optional uint32 top_k = 3;
    optional uint64 max_tokens = 4;
    optional float frequency_penalty = 5;
    optional float presence_penalty = 6;
    optional uint64 seed = 7;
    repeated string stop = 8;
}

message ResolvePresetResponse {
    // Whether a preset was found for the given tier + capability.
    bool found = 1;
    // The resolved model identifier (set when found = true).
    optional string model_id = 2;
    // Default generation parameters (set when found = true and preset has params).
    optional ProtoPresetParameters parameters = 3;
}

// Tier entry in a ListPresets response: one tier with its capability names.
message PresetTierEntry {
    string tier = 1;
    repeated string capabilities = 2;
}

message ListPresetsRequest {}

message ListPresetsResponse {
    repeated PresetTierEntry tiers = 1;
}
